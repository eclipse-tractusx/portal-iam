- [Summary](#summary)
  - [v1.7.0](#v170)
    - [Role Concept changes - UPDATE](#role-concept-changes---update)

## Summary

This document describes the keycloak database changes and its impact on transactional data. Depending on the impact, possible risks/impediments on upgrades as well as mitigation plans are described.
Each section includes the respective change details, impact on existing data and the respective release with which the change is getting active.

### v1.7.0

#### Role Concept changes - UPDATE

In the next Version the Roles 'App Tech User' & 'Connector User' in the client 'technical_user_management' will be removed. To assure that all Users which currently have one or both roles assigned have the correct roles in the future, the following script must be executed on the central idp database:

```sql
WITH connector_users AS (
    SELECT user_id
    FROM public.user_role_mapping AS urm
        JOIN public.keycloak_role AS kr 
        ON urm.role_id = kr.id
    WHERE kr.name = 'Connector User'
),
new_connector_roles_to_insert AS (
    SELECT DISTINCT atu.user_id, kr.id AS role_id
    FROM connector_users AS atu
    CROSS JOIN (
        SELECT id
        FROM public.keycloak_role
        WHERE name IN ('Semantic Model Management', 'Dataspace Discovery')
    ) kr
)
INSERT INTO public.user_role_mapping (user_id, role_id)
SELECT rt.user_id, rt.role_id
FROM new_connector_roles_to_insert rt
    LEFT JOIN public.user_role_mapping urm
    ON rt.user_id = urm.user_id AND rt.role_id = urm.role_id
WHERE urm.user_id IS NULL;

WITH app_tech_users AS (
    SELECT user_id
    FROM public.user_role_mapping AS urm
        JOIN public.keycloak_role AS kr
        ON urm.role_id = kr.id
    WHERE kr.name = 'App Tech User'
),
roles_to_insert AS (
    SELECT DISTINCT atu.user_id, kr.id AS role_id
    FROM app_tech_users AS atu
    CROSS JOIN (
        SELECT id
        FROM public.keycloak_role
        WHERE name IN ('Semantic Model Management', 'Dataspace Discovery', 'CX Membership Info')
    ) kr
)
INSERT INTO public.user_role_mapping (user_id, role_id)
SELECT rt.user_id, rt.role_id
FROM roles_to_insert rt
    LEFT JOIN public.user_role_mapping urm
    ON rt.user_id = urm.user_id AND rt.role_id = urm.role_id
WHERE urm.user_id IS NULL;

INSERT INTO public.keycloak_role (id, client_realm_constraint, client_role, description, name, realm_id, client, realm)
SELECT gen_random_uuid(), client_realm_constraint, client_role, description, 'Offer Management', realm_id, client, realm
FROM public.keycloak_role
WHERE NAME = 'Service Management';

WITH service_management_users AS (
    SELECT user_id
    FROM public.user_role_mapping AS urm
        JOIN public.keycloak_role AS kr
        ON urm.role_id = kr.id
    WHERE kr.name = 'Service Management'
),
new_offer_management_roles_to_insert AS (
    SELECT DISTINCT atu.user_id, kr.id AS role_id
    FROM connector_users AS atu
    CROSS JOIN (
        SELECT id
        FROM public.keycloak_role
        WHERE name = 'Offer Management'
    ) kr
)
INSERT INTO public.user_role_mapping (user_id, role_id)
SELECT rt.user_id, rt.role_id
FROM roles_to_insert rt
    LEFT JOIN public.user_role_mapping urm
    ON rt.user_id = urm.user_id AND rt.role_id = urm.role_id
WHERE urm.user_id IS NULL;

DELETE FROM public.user_role_mapping
WHERE role_id in (
    SELECT id FROM public.keycloak_role AS kr
    WHERE kr.name = 'Connector User'
)

DELETE FROM public.user_role_mapping
WHERE role_id in (
    SELECT id FROM public.keycloak_role AS kr
    WHERE kr.name = 'App Tech User'
)

DELETE FROM public.user_role_mapping
WHERE role_id in (
    SELECT id FROM public.keycloak_role AS kr
    WHERE kr.name = 'Service Management'
)

DELETE FROM public.keycloak_role AS kr
WHERE kr.name = 'Service Management'

```

! Important ! the new roles: 'Semantic Model Management', 'Dataspace Discovery', 'CX Membership Info' must be existing in the central idp database

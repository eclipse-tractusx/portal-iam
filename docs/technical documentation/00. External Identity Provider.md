For federated identities, external identity providers are needed.
To support the external identity provider configuration, a user interface flow [Technical Integration IdP](https://github.com/eclipse-tractusx/portal-assets/tree/v1.6.1/developer/02.%20Technical%20Integration/02.%20Identity%20Provider%20Management) is implement with which company admins can create / configure the company IdP as external IdP.
For details, please follow the provided link.

## How does the external IdP connection work?

Similar like the sharedIdP which is configured for all companies using the catena-x IdP as authentication provider; external company IdPs getting similarily configured.
The company idP is created as external IdP inside the "Identity Provider" menu of the leading realm.

![identityProviders](/docs/static/00_identityProviders.png)

Keycloak does in general support a huge number of idp(s) - however for Catena-X social network IdPs as well as SAML connections are not planned to get supported. Instead all connections are considered as OIDC connections.

![addProviderMenu](/docs/static/00_addProviderMenu.png)

IdPs are created with the following paraemter

- Alias (unique name)
- Display Name (IdP display name in the login page)
- Metadata URL (metadata url of the external IdP for automatic configuration)

![addProviderMenu](/docs/static/00_addIdp.png)

![addProviderMenu](/docs/static/00_importExternalIdpConfig.png)

To ensure that the auto user creation is disabled (important to not generate a out of sync mode between the keycloak db and portal db) the "First Login Flow" need to get set to "Login without auto user creation" (customized theme create by CX consortia and part of the release package).

![addProviderMenu](/docs/static/00_firstLoginFlow.png)

Last but not least the client id and secret of the external IdP is needed to establish the trust between both the idps.

![addProviderMenu](/docs/static/00_clientData.png)

After this generic settings are done, the idp is successfully configured.
Each IdP will get automatically (when created via endpoint - which is strongly suggested to ensure a in-sync state of the keycloak and portal db) generate the necessary mappers.
IdP mappers are used to import OIDC ID/Access token claims into user attributes and user role mappings.

![addProviderMenu](/docs/static/00_mappers.png)

Individual mappers are possible; but not suggested.
